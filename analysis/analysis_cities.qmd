---
title: "analysis_cities"
author: "olaf könig"
format: html
editor: visual
---

# Loading data

```{r}

sf_municipalities <- read_sf("data_input/data_raw/sf_polg_swisstopo.gpkg")

df_cities_pop <- read_csv("data_input/data_raw/stats_cities.csv") %>% 
  select(bfs_nummer,nom_officiel, POP_2023)

list_cities_10 <- cities_pop %>% 
  slice_max(POP_2023, n=10) %>% 
  pull(bfs_nummer)

list_cities_6 <- cities_pop %>% 
  slice_max(POP_2023, n=6) %>% 
  pull(bfs_nummer)

sf_cities_10 <- sf_municipalities %>% 
  filter(bfs_nummer %in% list_cities_10)

sf_cities_6 <- sf_municipalities %>% 
  filter(bfs_nummer %in% list_cities_6)
```

```{r}

cities_translation <-tibble::tibble(
  bfs_nummer = c(261, 6621, 2701, 5586, 351, 230, 1061, 3203, 5192, 371),
  name_en = c(
    "Zurich",
    "Geneva",
    "Basel",
    "Lausanne",
    "Bern",
    "Winterthur",
    "Lucerne",
    "St. Gallen",
    "Lugano",
    "Biel/Bienne"
  )
)
```

```{r}

sf <- read_sf("data_input/data_edit/sep_cross_noise_no2_ndvi.gpkg") %>% select(ssep3:geom) %>% select(id, bfs_nummer, everything()) %>% 
  filter(bfs_nummer %in% list_cities_10) %>% 
  left_join(cities_translation)

sf <- sf %>%
  mutate(
    ndvi_200m = 1 - ndvi_200m,
    ndvi_500m = 1 - ndvi_500m
  )
```

# Edit data

Create a list of sf object for each cities

```{r}

list_sf_by_commune <- sf %>%
  left_join(cities_translation) %>% 
  filter(bfs_nummer %in% list_cities_10) %>%
  { split(., .$bfs_nummer) }
```

View list (optional)

```{r}
# library(listviewer)
# jsonedit(list_sf_by_commune)
```

## Reclassify ssep and classify for noise, no2 and ndvi

```{r}

library(dplyr)
library(purrr)

prepare_groupings <- function(df) {
  df %>%
    mutate(
      ssep3d_local_4  = ntile(ssep3, 4),
      ssep3d_local_5  = ntile(ssep3, 5),
      ssep3d_local_10 = ntile(ssep3, 10),
      noise_4  = ntile(noise, 4),
      noise_5  = ntile(noise, 5),
      noise_10 = ntile(noise, 10),
      no2_4    = ntile(no2, 4),
      no2_5    = ntile(no2, 5),
      no2_10   = ntile(no2, 10),
      ndvi_200m_4  = ntile(ndvi_200m, 4),
      ndvi_200m_5  = ntile(ndvi_200m, 5),
      ndvi_200m_10 = ntile(ndvi_200m, 10)
    )
}

list_sf_by_commune_grouped <- map(list_sf_by_commune, prepare_groupings)

```

## Compute agregated statistics for each quantiles

```{r}

summarise_by_grouping <- function(sf_commune, grouping_var) {
  sf_commune %>%
    st_drop_geometry() %>%
    group_by(bfs_nummer, .data[[grouping_var]]) %>%
    summarise(
      n = n(),
      pct_above_50_noise = mean(noise > 50) * 100,
      pct_above_60_noise = mean(noise > 60) * 100,
      pct_above_15_no2   = mean(no2 > 15) * 100,
      pct_above_20_no2   = mean(no2 > 20) * 100,
      pct_above_50_ndvi  = mean(ndvi_200m > 0.5) * 100,
      pct_above_60_ndvi  = mean(ndvi_200m > 0.6) * 100,
      .groups = "drop"
    )
}

# For quintiles
df_stats_quintiles <- map_dfr(
  list_sf_by_commune_grouped,
  summarise_by_grouping,
  grouping_var = "ssep3d_local_5"
)
# For quartiles
df_stats_quartiles <- map_dfr(
  list_sf_by_commune_grouped,
  summarise_by_grouping,
  grouping_var = "ssep3d_local_4"
)
# For deciles
df_stats_deciles <- map_dfr(
  list_sf_by_commune_grouped,
  summarise_by_grouping,
  grouping_var = "ssep3d_local_10"
)
```

### Merge the results into one df and transforme to long

```{r}

df_stats_deciles   <- mutate(df_stats_deciles,   quantile_type = "Déciles")
df_stats_quintiles <- mutate(df_stats_quintiles, quantile_type = "Quintiles")
df_stats_quartiles <- mutate(df_stats_quartiles, quantile_type = "Quartiles")

df_stats_deciles <- df_stats_deciles %>%
  rename(group = ssep3d_local_10) %>%
  select(
    bfs_nummer,
    group,
    quantile_type,
    matches("^pct_above") # plus besoin de ^pct_below
  )

df_stats_quintiles <- df_stats_quintiles %>%
  rename(group = ssep3d_local_5) %>%
  select(
    bfs_nummer,
    group,
    quantile_type,
    matches("^pct_above")
  )

df_stats_quartiles <- df_stats_quartiles %>%
  rename(group = ssep3d_local_4) %>%
  select(
    bfs_nummer,
    group,
    quantile_type,
    matches("^pct_above")
  )

df_stats_all <- bind_rows(df_stats_deciles, df_stats_quintiles, df_stats_quartiles)

df_stats_long <- df_stats_all %>%
  pivot_longer(
    cols = matches("^pct_above"),
    names_to = "indicator",
    values_to = "value"
  ) %>%
  mutate(
    indicator_label = recode(indicator,
      "pct_above_50_noise" = "Bruit > 50 dB",
      "pct_above_60_noise" = "Bruit > 60 dB",
      "pct_above_15_no2"  = "NO2 > 15",
      "pct_above_20_no2"  = "NO2 > 20",
      "pct_above_50_ndvi" = "Limited green access (NDVI < 0.5)",
      "pct_above_60_ndvi" = "Limited green access (NDVI < 0.6)"
    )
  ) %>% 
  left_join(cities_translation)

df_stats_long <- df_stats_long %>%
  mutate(
    indicator_family = case_when(
      grepl("noise", indicator) ~ "Bruit",
      grepl("no2", indicator) ~ "NO2",
      grepl("ndvi", indicator) ~ "NDVI"
    )
  )

```

Colors

```{r}

df_stats_long <- df_stats_long %>%
  mutate(
    indicator_label = recode(indicator,
      "pct_above_50_noise" = "Exposed to noise >50 dB",
      "pct_above_60_noise" = "Exposed to noise >60 dB",
      "pct_above_15_no2"   = "Exposed to NO₂ >15 μg/m³",
      "pct_above_20_no2"   = "Exposed to NO₂ >20 μg/m³",
      "pct_above_50_ndvi"  = "Limited green access (NDVI < 0.5)",
      "pct_above_60_ndvi"  = "Limited green access (NDVI < 0.6)"
    )
  )
```

## Visualise

```{r}

df_minimal <- df_stats_long %>%
  filter(
    indicator_label %in% c(
      "Exposed to noise >50 dB",
      "Exposed to NO₂ >20 μg/m³",
      "Limited green access (NDVI < 0.5)"
    )
  )
table(df_minimal$indicator_label)

```

## Batch chart svg export

```{r}

output_dir <- "data_output/city_charts_minimal_svg/"
dir_create(output_dir)

unique_codes <- unique(df_minimal$bfs_nummer)

plot_city <- function(city_code) {
  df_city <- df_minimal %>% filter(bfs_nummer == city_code)
  ggplot(
    df_city,
    aes(
      y = factor(group),
      x = value,
      fill = indicator_label
    )
  ) +
    geom_col(
      width = 0.7,
      position = position_dodge(width = 0.8)
    ) +
    geom_text(
      aes(label = sprintf("%.1f", value), colour = indicator_label),
      position = position_dodge(width = 0.8),
      hjust = -0.15,
      size = 3.2,
      family = "IBM Plex Sans"
    ) +
    scale_fill_manual(
      values = c(
        "Exposed to noise >50 dB"           = "#FC9272",  # orange
        "Exposed to NO₂ >20 μg/m³"          = "#4882A1",  # bleu
        "Limited green access (NDVI < 0.5)" = "#A1D99B"   # vert
      )
    ) +
    scale_colour_manual(
      values = c(
        "Exposed to noise >50 dB"           = "#FC9272",
        "Exposed to NO₂ >20 μg/m³"          = "#4882A1",
        "Limited green access (NDVI < 0.5)" = "#A1D99B"
      )
    ) +
    facet_grid(quantile_type ~ indicator_family, switch = "y") +
    labs(
      title = paste("Environmental exposures –", unique(df_city$name_en)),
      y = "Group (local SES quartile/quintile/decile)",
      x = "Share of exposed households (%)",
      fill = NULL
    ) +
    theme_minimal(base_family = "IBM Plex Sans") +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title.y = element_text(face = "bold"),
      axis.title.x = element_text(face = "bold"),
      legend.position = "bottom"
    ) +
    coord_cartesian(xlim = c(0, max(df_city$value, na.rm = TRUE) * 1.15))
}

walk(unique_codes, ~{
  g <- plot_city(.x)
  ggsave(
    filename = path(output_dir, paste0("city_", .x, ".svg")),
    plot = g,
    width = 8, height = 5
  )
  invisible(NULL)
})

```

## DW lollipop chart to show disparities within the cities

<https://app.datawrapper.de/edit/iLHkd/visualize#refine>

```{r}
dw_cities_lolipop <- df_stats_long %>% 
  filter(
    quantile_type == "Quartiles",
    group %in% c(1, 4),
    indicator_label %in% c(
      "Exposed to noise >50 dB",
      "Exposed to NO₂ >15 μg/m³",
      "Limited green access (NDVI < 0.5)"
    )
  ) %>% 
  select(bfs_nummer, name_en, group, indicator_label, value) %>% 
  mutate(
    indicator_label_en = case_when(
      indicator_label == "Exposed to noise >50 dB" ~ "Households exposed to noise >50 dB",
      indicator_label == "Exposed to NO₂ >15 μg/m³" ~ "Households exposed to NO₂ >15 μg/m³",
      indicator_label == "Limited green access (NDVI < 0.5)" ~ 'Households with limited green access: less than 50% of "green" surfaces within 200m'
    )
  ) %>% 
  pivot_wider(
    names_from = "group",
    values_from = "value"
  ) %>% 
  rename(
    "Lowest SES" = `1`,
    "Highest SES" = `4`
  )

```

```{r}

dw_cities_lolipop %>% 
  dw_data_to_chart("iLHkd")
```

# Scatterplot charts

### Classification in quartles (string)

```{r}

sf_grouped <- bind_rows(list_sf_by_commune_grouped)

sf_grouped <- sf_grouped %>%
  mutate(
    # Paires SES avec chaque variable
    ssep_noise_pair = paste0("SES", ssep3d_local_4, "-Noise", noise_4),
    ssep_no2_pair   = paste0("SES", ssep3d_local_4, "-NO2", no2_4),
    ssep_ndvi_pair  = paste0("SES", ssep3d_local_4, "-Green", ndvi_200m_4),
    
    # Labels explicites avec inversion corrigée : 1 = Low SES, 4 = High SES
    ssep_noise_label = case_when(
      ssep3d_local_4 == 1 & noise_4 == 4 ~ "Low SES / High Noise",
      ssep3d_local_4 == 1 & noise_4 == 1 ~ "Low SES / Low Noise",
      ssep3d_local_4 == 4 & noise_4 == 4 ~ "High SES / High Noise",
      ssep3d_local_4 == 4 & noise_4 == 1 ~ "High SES / Low Noise",
      TRUE ~ "Other combination"
    ),
    ssep_no2_label = case_when(
      ssep3d_local_4 == 1 & no2_4 == 4 ~ "Low SES / High NO₂",
      ssep3d_local_4 == 1 & no2_4 == 1 ~ "Low SES / Low NO₂",
      ssep3d_local_4 == 4 & no2_4 == 4 ~ "High SES / High NO₂",
      ssep3d_local_4 == 4 & no2_4 == 1 ~ "High SES / Low NO₂",
      TRUE ~ "Other combination"
    ),
    ssep_ndvi_label = case_when(
      ssep3d_local_4 == 1 & ndvi_200m_4 == 4 ~ "Low SES / Low Green",
      ssep3d_local_4 == 1 & ndvi_200m_4 == 1 ~ "Low SES / High Green",
      ssep3d_local_4 == 4 & ndvi_200m_4 == 4 ~ "High SES / Low Green",
      ssep3d_local_4 == 4 & ndvi_200m_4 == 1 ~ "High SES / High Green",
      TRUE ~ "Other combination"
    ),
    # Combinaison globale (corrigée)
    ssep_global_label = paste0(
      ifelse(ssep3d_local_4 == 1, "Low SES", ifelse(ssep3d_local_4 == 4, "High SES", "Mid SES")), " / ",
      ifelse(no2_4 == 1, "Low NO₂", ifelse(no2_4 == 4, "High NO₂", "Mid NO₂")), " / ",
      ifelse(noise_4 == 1, "Low Noise", ifelse(noise_4 == 4, "High Noise", "Mid Noise")), " / ",
      ifelse(ndvi_200m_4 == 1, "Low Green", ifelse(ndvi_200m_4 == 4, "High Green", "Mid Green"))
    )
  )

```

## Making scatterplot template

#### Helper: descritptive statistics to adjust axes

```{r}

desc_stats <- function(x, na.rm = TRUE) {
  data.frame(
    min = min(x, na.rm = na.rm),
    q10 = quantile(x, 0.1, na.rm = na.rm),
    q25 = quantile(x, 0.25, na.rm = na.rm),
    median = quantile(x, 0.5, na.rm = na.rm),
    q75 = quantile(x, 0.75, na.rm = na.rm),
    q90 = quantile(x, 0.9, na.rm = na.rm),
    max = max(x, na.rm = na.rm)
  )
}

# desc_stats(sf_grouped$ndvi_200m)
# desc_stats(sf_grouped$no2)
# desc_stats(sf_grouped$noise)
```

### Template noise

<https://app.datawrapper.de/edit/fTu0m/upload>

```{r}

sf_grouped %>% 
  st_drop_geometry() %>% 
  filter(bfs_nummer == 230) %>% 
  select(ssep3, noise, ssep_noise_label) %>% 
  dw_data_to_chart("fTu0m")
```

### Template NO2

<https://app.datawrapper.de/edit/i3eIP/visualize#annotate>

```{r}

sf_grouped %>% 
  st_drop_geometry() %>% 
  filter(bfs_nummer == 230) %>% 
  select(ssep3, no2, ssep_no2_label) %>% 
  dw_data_to_chart("i3eIP")
```

### Template Green

<https://app.datawrapper.de/edit/yVzPw/visualize#annotate>

```{r}

sf_grouped %>% 
  st_drop_geometry() %>% 
  filter(bfs_nummer == 230) %>% 
  select(ssep3, ndvi_200m, ssep_ndvi_label) %>%
  mutate(ndvi_200m = ndvi_200m * 100) %>% 
  dw_data_to_chart("yVzPw")
```

## DW Scatterplot batch production

```{r}

library(dplyr)
library(purrr)
library(DatawRappr)

dw_batch_charts_by_indicator <- function(
  df,
  bfs_list,
  template_ids = list(
    noise = "fTu0m",
    no2   = "i3eIP",
    green = "yVzPw"
  ),
  folder_ids = list(
    noise = "335712",
    no2   = "335711",
    green = "335713"
  ),
  output_chart_infos = "chart_ids.RData"
) {
  indicator_vars <- list(
    noise = list(var = "noise", label = "ssep_noise_label"),
    no2   = list(var = "no2", label = "ssep_no2_label"),
    green = list(var = "ndvi_200m", label = "ssep_ndvi_label")
  )
  
  create_city_chart <- function(city_id, indicator) {
    var_info <- indicator_vars[[indicator]]
    template_id <- template_ids[[indicator]]
    folder_id <- folder_ids[[indicator]]
    
    df_city <- df %>%
      filter(bfs_nummer == city_id) %>%
      st_drop_geometry()
    city_name <- unique(df_city$name_en)
    city_name <- paste0('<span style="font-size: 0.8em;">', city_name, '</span>')
    if(length(city_name) != 1) city_name <- as.character(city_id)
    
    new_chart <- dw_copy_chart(template_id)
    new_chart_id <- new_chart[["id"]]
    
    dw_edit_chart(
      chart_id = new_chart_id,
      title = city_name,
      folderId = folder_id
    )
    
    data_to_send <- df_city %>%
      select(
        ssep3,
        value = all_of(var_info$var),
        indicator_label = all_of(var_info$label)
      )
    if (indicator == "green") {
      data_to_send <- data_to_send %>% mutate(value = value * 100)
    }
    
    dw_data_to_chart(
      data_to_send,
      chart_id = new_chart_id
    )
    
    published_chart <- dw_publish_chart(new_chart_id, return_object = TRUE)
    
    tibble(
      city_id = city_id,
      city_name = city_name,
      indicator = indicator,
      url = published_chart$publicUrl,
      iframe = published_chart$iframeCode,
      chart_id = new_chart_id
    )
  }
  
  chart_infos <- purrr::cross_df(list(
    city_id = bfs_list,
    indicator = names(template_ids)
  )) %>%
    pmap_dfr(~create_city_chart(..1, ..2))
  
  saveRDS(chart_infos, output_chart_infos)
  chart_infos
}

```

```{r}

bfs_list <- sf_grouped %>% 
  st_drop_geometry() %>% 
  pull(bfs_nummer) %>% 
  unique()

chart_results <- dw_batch_charts_by_indicator(
  df = sf_grouped,
  bfs_list = bfs_list,
  output_chart_infos = "data_output/scatterplot_chart_ids.RData"
)

```

# Cartography cities

```{r}


```
